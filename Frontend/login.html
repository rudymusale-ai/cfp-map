<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Connexion</title>
<link rel="stylesheet" href="theme.css">
</head>

<body class="auth">

<div class="auth-shell">
    <div class="auth-card">
        <div class="auth-head">
            <span class="badge">Accès</span>
            <h2>Connexion</h2>
            <p class="muted" style="margin:6px 0 0;">Connectez-vous pour accéder à votre tableau de bord.</p>
        </div>

        <label class="field">
            <span>Email ou Username</span>
            <input type="text" id="email" placeholder="ex: admin@cfp.cd">
        </label>
        <label class="field">
            <span>Mot de passe</span>
            <input type="password" id="password" placeholder="Votre mot de passe">
        </label>

        <button class="btn btn-primary" onclick="login()">Se connecter</button>

        <p id="error" class="auth-error"></p>
    </div>
</div>

<script src="app-data.js"></script>
<script>
const API_BASE = "https://cfp-map-production.up.railway.app";

function mapServerError(raw) {
    const key = String(raw || "").trim();
    const map = {
        "Utilisateur introuvable": "Utilisateur introuvable",
        "user_not_found": "Utilisateur introuvable",
        "User not found": "Utilisateur introuvable",
        "invalid_credentials": "Email ou mot de passe incorrect",
        "Invalid credentials": "Email ou mot de passe incorrect"
    };
    return map[key] || raw;
}

function login() {

    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    const errorEl = document.getElementById("error");

    if (!email || !password) {
        errorEl.innerText = "Veuillez saisir l'email et le mot de passe";
        return;
    }

    fetch(API_BASE + "/auth/login", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            email: email,
            password: password
        })
    })
    .then(async res => {
        const contentType = res.headers.get("content-type") || "";
        const isJson = contentType.includes("application/json");
        const data = isJson ? await res.json().catch(() => null) : null;
        if (!res.ok) {
            let msg = "Erreur de connexion";
            if (res.status === 401 || res.status === 403) {
                msg = "Email ou mot de passe incorrect";
            } else if (res.status === 404) {
                msg = "API login introuvable";
            } else if (res.status === 405) {
                msg = "Méthode non autorisée (API login)";
            } else if (res.status >= 500) {
                msg = "Erreur serveur, réessayez plus tard";
            }
            if (data && data.error) msg = mapServerError(data.error);
            throw new Error(msg);
        }
        if (!data || !data.token) {
            throw new Error("Réponse serveur non valide");
        }
        return data;
    })
    .then(data => {
        localStorage.setItem("token", data.token);
        window.location.href = "dashboard.html";
    })
    .catch(err => {
        console.error(err);
        const msg = err && err.message ? err.message : "";
        if (msg === "Failed to fetch") {
            errorEl.innerText = "Serveur injoignable (backend non démarré)";
        } else {
            errorEl.innerText = msg || "Erreur serveur";
        }
    });
}

</script>

</body>
</html>
