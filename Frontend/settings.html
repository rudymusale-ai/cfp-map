<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ParamÃ¨tres systÃ¨me</title>
<link rel="stylesheet" href="theme.css">

<style>
.settings-grid{margin-top:16px}
</style>
</head>

<body>

<div id="nav-placeholder"></div>

<div class="page">
<div class="hero" style="margin-bottom:16px;">
  <div>
    <span class="badge">ParamÃ¨tres</span>
    <h2>ParamÃ¨tres systÃ¨me</h2>
    <p class="muted">GÃ©rez les rÃ©fÃ©rentiels et lâ€™annÃ©e active.</p>
  </div>
</div>

<div class="grid grid-2 settings-grid">

<!-- FiliÃ¨res -->
<div class="card">
<h3>FiliÃ¨res</h3>
<input id="newFiliere" placeholder="Nouvelle filiÃ¨re">
<button class="btn btn-primary" onclick="add('filieres')">Ajouter</button>
<div class="list" id="filieres"></div>
</div>

<!-- Sous-divisions -->
<div class="card">
<h3>Sous-divisions</h3>
<input id="newSous" placeholder="Nouvelle sous-division">
<button class="btn btn-primary" onclick="add('sousdivisions')">Ajouter</button>
<div class="list" id="sousdivisions"></div>
</div>

<!-- Equipements -->
<div class="card">
<h3>Types Ã©quipements</h3>
<input id="newEquip" placeholder="Nouvel Ã©quipement">
<button class="btn btn-primary" onclick="add('equipements')">Ajouter</button>
<div class="list" id="equipements"></div>
</div>

<!-- AnnÃ©e active -->
<div class="card">
<h3>AnnÃ©e active</h3>
<input id="annee" type="number">
<button class="btn btn-primary" onclick="saveYear()">Enregistrer</button>
</div>

<!-- Sauvegarde -->
<div class="card">
<h3>Sauvegarde Base de DonnÃ©es</h3>
<button class="btn btn-ghost" onclick="backup()">ğŸ’¾ Lancer sauvegarde</button>
</div>
</div>
</div>

<script src="app-data.js?v=20260207"></script>
<script>

async function fetchJsonOrFallback(url, fallback) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("bad_status");
    return await res.json();
  } catch (e) {
    return fallback();
  }
}

const esc = window.escapeHtml || ((v) => v);

function load(){

["filieres","sousdivisions","equipements"].forEach(type=>{
 fetchJsonOrFallback(`/settings/${type}`, () => AppData.getSettings(type))
 .then(data=>{
   let h="";
   data.forEach(e=>{
     const id = Number(e.id) || 0;
     h+=`
     <div>
       ${esc(e.nom)}
       <button class="btn btn-ghost btn-xs" onclick="del('${type}',${id})">Supprimer</button>
     </div>`;
   });
   document.getElementById(type).innerHTML=h;
 });
});

fetchJsonOrFallback('/settings/year', () => AppData.getYear())
.then(y=>annee.value=y);

}

load();
</script>
<script src="nav-auth.js"></script>
<script>
initNavAuth();
</script>
<script>
function add(type){

let val="";
if(type==="filieres") val=newFiliere.value;
if(type==="sousdivisions") val=newSous.value;
if(type==="equipements") val=newEquip.value;

fetch(`/settings/${type}`,{
 method:"POST",
 headers:{'Content-Type':'application/json'},
 body:JSON.stringify({nom:val})
}).then((res)=>{
  if(!res.ok) throw new Error("bad_status");
  load();
}).catch(()=>{
  AppData.addSetting(type, val);
  load();
});

}

function del(type,id){
 fetch(`/settings/${type}/${id}`,{method:"DELETE"}).then((res)=>{
  if(!res.ok) throw new Error("bad_status");
  load();
 }).catch(()=>{
  AppData.deleteSetting(type, id);
  load();
});
}

function saveYear(){
 fetch('/settings/year',{
 method:"POST",
 headers:{'Content-Type':'application/json'},
 body:JSON.stringify({annee:annee.value})
 }).then((res)=>{
  if(!res.ok) throw new Error("bad_status");
  alert("AnnÃ©e enregistrÃ©e");
 }).catch(()=>{
  AppData.setYear(annee.value);
  alert("AnnÃ©e enregistrÃ©e (local)");
 });
}

function downloadJson(data, filename){
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

function backup(){
 fetch('/settings/backup')
  .then((res)=>{
    if(!res.ok) throw new Error("bad_status");
    return res.json();
  })
  .then((data)=>{
    const stamp = new Date().toISOString().slice(0,10);
    downloadJson(data, `cfp_backup_${stamp}.json`);
    alert("Sauvegarde tÃƒÂ©lÃƒÂ©chargÃƒÂ©e");
  })
  .catch(()=>{
    const data = {
      centres: AppData.getCentres(),
      users: AppData.getUsers(),
      settings: {
        filieres: AppData.getSettings("filieres"),
        sousdivisions: AppData.getSettings("sousdivisions"),
        equipements: AppData.getSettings("equipements")
      },
      year: AppData.getYear()
    };
    const stamp = new Date().toISOString().slice(0,10);
    downloadJson(data, `cfp_backup_local_${stamp}.json`);
    alert("Sauvegarde locale tÃƒÂ©lÃƒÂ©chargÃƒÂ©e");
  });
}

</script>

</body>
</html>

